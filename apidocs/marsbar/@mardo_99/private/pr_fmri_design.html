<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of pr_fmri_design</title>
  <meta name="keywords" content="pr_fmri_design">
  <meta name="description" content="MarsBaR version of spm_fMRI design - asssembles a design for fMRI studies">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html &copy; 2003-2019 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../../../m2html.css">
</head>
<body>
<a name="_top"></a>
<div><a href="../../../index.html">Home</a> &gt;  <a href="../../index.html">marsbar</a> &gt; <a href="../index.html">@mardo_99</a> &gt; <a href="index.html">private</a> &gt; pr_fmri_design.m</div>

<!--<table width="100%"><tr><td align="left"><a href="../../../index.html"><img alt="<" border="0" src="../../../left.png">&nbsp;Master index</a></td>
<td align="right"><a href="index.html">Index for marsbar/@mardo_99/private&nbsp;<img alt=">" border="0" src="../../../right.png"></a></td></tr></table>-->

<h1>pr_fmri_design
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="box"><strong>MarsBaR version of spm_fMRI design - asssembles a design for fMRI studies</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="box"><strong>function [SPM] = pr_fmri_design(SPM) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="fragment"><pre class="comment"> MarsBaR version of spm_fMRI design - asssembles a design for fMRI studies
 FORMAT [SPM] = pr_fmri_design(SPM)

 This file is a hardly edited version of:
 @(#)spm_fMRI_design.m    2.27   Karl Friston 99/09/29
 See that (SPM99) version for comments etc

 $Id$ 
</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../../../matlabicon.gif)">
<li><a href="../../../marsbar/@mardo/isempty.html" class="code" title="function tf = isempty(o)">isempty</a>	overloaded isempty method for mardo object</li>
<li><a href="../../../marsbar/@mardo_2/private/pr_spm_get_bf.html" class="code" title="function [xBF] = pr_spm_get_bf(xBF)">pr_spm_get_bf</a>	fills in basis function structure</li>
<li><a href="../../../marsbar/@mardo_2/private/pr_spm_get_ons.html" class="code" title="function [U] = pr_spm_get_ons(SPM,s)">pr_spm_get_ons</a>	returns input [designed effects] structures</li>
<li><a href="../../../marsbar/@mardo_2/private/pr_spm_volterra.html" class="code" title="function [X,Xname,Fc] = spm_Volterra(U,bf,V)">pr_spm_volterra</a>	generalized convolution of inputs (U) with basis set (bf)</li>
<li><a href="../../../marsbar/@mardo_5/private/pr_spm_get_bf.html" class="code" title="function [xBF] = pr_spm_get_bf(xBF)">pr_spm_get_bf</a>	fills in basis function structure</li>
<li><a href="../../../marsbar/@mardo_5/private/pr_spm_get_ons.html" class="code" title="function [U] = pr_spm_get_ons(SPM,s)">pr_spm_get_ons</a>	returns input [designed effects] structures</li>
<li><a href="../../../marsbar/@mardo_5/private/pr_spm_volterra.html" class="code" title="function [X,Xname,Fc] = pr_spm_volterra(U,bf,V)">pr_spm_volterra</a>	generalized convolution of inputs (U) with basis set (bf)</li>
<li><a href="pr_spm_get_bf.html" class="code" title="function [BF,BFstr] = pr_spm_get_bf(name,T,dt,Fstr,n_s,n_c)">pr_spm_get_bf</a>	creates basis functions for each trial type {i} in struct BF{i}</li>
<li><a href="pr_spm_get_ons.html" class="code" title="function [sf,Cname,Pv,Pname,DSstr] = pr_spm_get_ons(k,T,dt,STOC,Fstr,v,Cname,s)">pr_spm_get_ons</a>	returns onset times for events</li>
<li><a href="pr_spm_volterra.html" class="code" title="function [X,Xn,IND,BF,name] = spm_Volterra(SF,BF,name,N)">pr_spm_volterra</a>	returns [design] matrix of explanatory variables</li>
<li><a href="../../../marsbar/marsbar.html" class="code" title="function varargout=marsbar(varargin)">marsbar</a>	Startup, callback and utility routine for Marsbar</li>
</ul>
This function is called by:
<ul style="list-style-image:url(../../../matlabicon.gif)">
<li><a href="../../../marsbar/@mardo_2/ui_build.html" class="code" title="function D = ui_build(D, dtype)">ui_build</a>	method to create / fill design via GUI</li>
<li><a href="../../../marsbar/@mardo_5/ui_build.html" class="code" title="function D = ui_build(D, dtype)">ui_build</a>	method to create / fill design via GUI</li>
<li><a href="../../../marsbar/@mardo_99/ui_build.html" class="code" title="function D = ui_build(D, dtype)">ui_build</a>	method to create / fill design via GUI</li>
</ul>
<!-- crossreference -->



<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function [SPM] = pr_fmri_design(SPM)</a>
0002 <span class="comment">% MarsBaR version of spm_fMRI design - asssembles a design for fMRI studies</span>
0003 <span class="comment">% FORMAT [SPM] = pr_fmri_design(SPM)</span>
0004 <span class="comment">%</span>
0005 <span class="comment">% This file is a hardly edited version of:</span>
0006 <span class="comment">% @(#)spm_fMRI_design.m    2.27   Karl Friston 99/09/29</span>
0007 <span class="comment">% See that (SPM99) version for comments etc</span>
0008 <span class="comment">%</span>
0009 <span class="comment">% $Id$</span>
0010   
0011 <span class="comment">%-GUI setup</span>
0012 <span class="comment">%-----------------------------------------------------------------------</span>
0013 SPMid    = spm(<span class="string">'SFnBanner'</span>,mfilename,<a href="../../../marsbar/marsbar.html" class="code" title="function varargout=marsbar(varargin)">marsbar</a>(<span class="string">'ver'</span>));
0014 [Finter,Fgraph,CmdLine] = spm(<span class="string">'FnUIsetup'</span>,<span class="string">'fMRI stats model setup'</span>,0);
0015 spm_help(<span class="string">'!ContextHelp'</span>,mfilename)
0016 
0017 <span class="comment">% construct Design matrix {X} - cycle over sessions</span>
0018 <span class="comment">%=======================================================================</span>
0019 
0020 <span class="comment">% Initialize variables</span>
0021 <span class="comment">%-----------------------------------------------------------------------</span>
0022 STOC   = 0;
0023 
0024 <span class="comment">% global parameters</span>
0025 <span class="comment">%-----------------------------------------------------------------------</span>
0026 <span class="keyword">global</span> fMRI_T; 
0027 <span class="keyword">global</span> fMRI_T0; 
0028 <span class="keyword">if</span> <a href="../../../marsbar/@mardo/isempty.html" class="code" title="function tf = isempty(o)">isempty</a>(fMRI_T),  fMRI_T  = 16; <span class="keyword">end</span>;
0029 <span class="keyword">if</span> <a href="../../../marsbar/@mardo/isempty.html" class="code" title="function tf = isempty(o)">isempty</a>(fMRI_T0), fMRI_T0 = 1;  <span class="keyword">end</span>;
0030 
0031 <span class="comment">% get nscan and RT</span>
0032 <span class="comment">%-----------------------------------------------------------------------</span>
0033 spm_input(<span class="string">'Basic parameters...'</span>,1,<span class="string">'d'</span>,mfilename)
0034 RT = spm_input(<span class="string">'Interscan interval {secs}'</span>,<span class="string">'+1'</span>,<span class="string">'r'</span>,[],1);
0035 nscan = spm_input([<span class="string">'scans per session e.g. 64 64 64'</span>],<span class="string">'+1'</span>);
0036 STOC   = 1;
0037 nsess  = length(nscan);
0038 dt     = RT/fMRI_T;                    <span class="comment">% time bin {secs}</span>
0039 
0040 <span class="comment">% separate specifications for non-relicated sessions</span>
0041 <span class="comment">%-----------------------------------------------------------------------</span>
0042 rep = 0;
0043 tim = 0;
0044 <span class="keyword">if</span> nsess &gt; 1
0045     str = <span class="string">'are conditions replicated'</span>;
0046     rep = spm_input(str,<span class="string">'+1'</span>,<span class="string">'yes|no'</span>,[1 0])
0047     <span class="keyword">if</span> rep &amp; ~any(nscan - nscan(1))
0048         str = [<span class="string">'are timing/parameters the same'</span>];
0049         tim = spm_input(str,<span class="string">'+1'</span>,<span class="string">'yes|no'</span>,[1 0]);
0050     <span class="keyword">end</span>
0051 <span class="keyword">end</span>
0052 Xx    = [];
0053 Xb    = [];
0054 Xname = {};
0055 Bname = {};
0056 Sess  = {};
0057 <span class="keyword">for</span> s = 1:nsess
0058 
0059     <span class="comment">% set prompt string</span>
0060     <span class="comment">%---------------------------------------------------------------</span>
0061     <span class="keyword">if</span> tim
0062         Fstr = <span class="string">'All sessions'</span>;
0063     <span class="keyword">else</span>
0064         Fstr = sprintf(<span class="string">'Session %d/%d'</span>,s,nsess);
0065     <span class="keyword">end</span>
0066 
0067     <span class="comment">% Event/epoch related responses</span>
0068     <span class="comment">%===============================================================</span>
0069     k     = nscan(s);
0070 
0071     <span class="comment">% specify event/epoch onsets {SF} for this session</span>
0072     <span class="comment">%---------------------------------------------------------------</span>
0073     <span class="keyword">if</span> (s == 1) | ~rep
0074 
0075         [SF,Cname,Pv,Pname,DSstr] = <span class="keyword">...</span>
0076             <a href="pr_spm_get_ons.html" class="code" title="function [sf,Cname,Pv,Pname,DSstr] = pr_spm_get_ons(k,T,dt,STOC,Fstr,v,Cname,s)">pr_spm_get_ons</a>(k,fMRI_T,dt,STOC,Fstr,[],[],s);
0077         ntrial = size(SF,2);
0078 
0079     <span class="keyword">elseif</span> ~tim
0080 
0081         [SF,Cname,Pv,Pname,DSstr] = <span class="keyword">...</span>
0082             <a href="pr_spm_get_ons.html" class="code" title="function [sf,Cname,Pv,Pname,DSstr] = pr_spm_get_ons(k,T,dt,STOC,Fstr,v,Cname,s)">pr_spm_get_ons</a>(k,fMRI_T,dt,STOC,Fstr,ntrial,Cname,s);
0083     <span class="keyword">end</span>
0084 
0085     <span class="comment">% get basis functions for this session</span>
0086     <span class="comment">%---------------------------------------------------------------</span>
0087         <span class="keyword">if</span> (s == 1) | ~rep
0088 
0089         <span class="comment">% get basis functions for responses</span>
0090         <span class="comment">%-------------------------------------------------------</span>
0091         [BF BFstr] = <a href="pr_spm_get_bf.html" class="code" title="function [BF,BFstr] = pr_spm_get_bf(name,T,dt,Fstr,n_s,n_c)">pr_spm_get_bf</a>(Cname,fMRI_T,dt,Fstr,s);
0092     <span class="keyword">end</span>
0093 
0094 
0095 
0096 
0097     <span class="comment">% complete design matrix partition for this session</span>
0098     <span class="comment">%---------------------------------------------------------------</span>
0099         <span class="keyword">if</span> (s == 1) | ~tim
0100 
0101 
0102         <span class="comment">%-Reset ContextHelp</span>
0103         <span class="comment">%-------------------------------------------------------</span>
0104         spm_help(<span class="string">'!ContextHelp'</span>,mfilename)
0105         spm_input(<span class="string">'Design matrix options...'</span>,1,<span class="string">'d'</span>,mfilename)
0106 
0107         <span class="keyword">if</span> ~ntrial
0108 
0109             <span class="comment">% declare variables</span>
0110             <span class="comment">%-----------------------------------------------</span>
0111             ONS     = {};        <span class="comment">% onset times</span>
0112             PST     = {};        <span class="comment">% Peri-stimulus times</span>
0113             X       = [];        <span class="comment">% design matrix</span>
0114             Xn      = {};        <span class="comment">% regressor names</span>
0115             IND     = {};        <span class="comment">% design matrix indices</span>
0116             name    = {};        <span class="comment">% condition names</span>
0117 
0118         <span class="keyword">else</span>
0119 
0120             <span class="comment">% peri-stimulus {PST} and onset {ONS} (seconds)</span>
0121             <span class="comment">%-----------------------------------------------</span>
0122             <span class="keyword">for</span>   i = 1:ntrial
0123                 on     = find(SF{i}(:,1))*dt;
0124                 pst    = [1:k]*RT - on(1);            
0125                 <span class="keyword">for</span>  j = 1:length(on)
0126                     u      = [1:k]*RT - on(j);
0127                     v      = find(u &gt;= -1);
0128                     pst(v) = u(v);
0129                 <span class="keyword">end</span>
0130                 ONS{i} = on;
0131                 PST{i} = pst;
0132             <span class="keyword">end</span>
0133 
0134 
0135             <span class="comment">% convolve with basis functions</span>
0136             <span class="comment">%-----------------------------------------------</span>
0137             str   = <span class="string">'interactions among trials (Volterra)'</span>;
0138             <span class="keyword">if</span> spm_input(str,<span class="string">'+1'</span>,<span class="string">'y/n'</span>,[1 0])
0139   
0140                 [X Xn IND BF name] = <a href="pr_spm_volterra.html" class="code" title="function [X,Xn,IND,BF,name] = spm_Volterra(SF,BF,name,N)">pr_spm_volterra</a>(SF,BF,Cname,2);
0141 
0142             <span class="keyword">else</span>
0143                 [X Xn IND BF name] = <a href="pr_spm_volterra.html" class="code" title="function [X,Xn,IND,BF,name] = spm_Volterra(SF,BF,name,N)">pr_spm_volterra</a>(SF,BF,Cname,1);
0144             <span class="keyword">end</span>
0145 
0146 
0147             <span class="comment">% Resample design matrix {X} at acquisition times</span>
0148             <span class="comment">%-----------------------------------------------</span>
0149             X     = X([0:k-1]*fMRI_T + fMRI_T0,:);
0150         <span class="keyword">end</span>
0151 
0152 
0153         <span class="comment">% get user specified regressors</span>
0154         <span class="comment">%=======================================================</span>
0155         spm_input(<span class="string">'Other regressors'</span>,1,<span class="string">'d'</span>,Fstr)
0156         D     = [];
0157         c     = spm_input(<span class="string">'user specified regressors'</span>,<span class="string">'+1'</span>,<span class="string">'w1'</span>,0);
0158                 <span class="keyword">while</span> size(D,2) &lt; c
0159               str   = sprintf(<span class="string">'regressor %i'</span>,size(D,2) + 1);
0160               D = [D spm_input(str,2,<span class="string">'e'</span>,[],[k Inf])];
0161         <span class="keyword">end</span>
0162         <span class="keyword">if</span>      c &amp; length(DSstr)
0163             DSstr = [DSstr <span class="string">'&amp; user specified covariates '</span>];
0164         <span class="keyword">elseif</span>  c
0165             DSstr = <span class="string">'User specified covariates '</span>;
0166         <span class="keyword">end</span>
0167 
0168         <span class="comment">% append regressors and names</span>
0169         <span class="comment">%-------------------------------------------------------</span>
0170         <span class="keyword">for</span> i = 1:size(D,2)
0171             X           = [X D(:,i)];
0172             str         = sprintf(<span class="string">'regressor: %i'</span>,i);
0173             Xn{end + 1} = spm_input([<span class="string">'name of '</span> str],<span class="string">'+0'</span>,<span class="string">'s'</span>,str);
0174         <span class="keyword">end</span>
0175 
0176 
0177 
0178         <span class="comment">% Confounds: Session effects</span>
0179         <span class="comment">%=======================================================</span>
0180         B      = ones(k,1);
0181         Bn{1}  = sprintf(<span class="string">'constant'</span>);
0182 
0183     <span class="keyword">end</span>
0184 
0185     <span class="comment">% Session structure</span>
0186     <span class="comment">%---------------------------------------------------------------</span>
0187     Sess{s}.BFstr = BFstr;
0188     Sess{s}.DSstr = DSstr;
0189     Sess{s}.rep   = tim;
0190     Sess{s}.row   = size(Xx,1) + [1:k];
0191     Sess{s}.col   = size(Xx,2) + [1:size(X,2)];
0192     Sess{s}.name  = name;
0193     Sess{s}.ind   = IND;
0194     Sess{s}.bf    = BF;
0195     Sess{s}.sf    = SF;
0196     Sess{s}.pst   = PST;
0197     Sess{s}.ons   = ONS;
0198     Sess{s}.Pv    = Pv;
0199     Sess{s}.Pname = Pname;
0200 
0201     <span class="comment">% Append names</span>
0202     <span class="comment">%---------------------------------------------------------------</span>
0203     q     = length(Xname);
0204     <span class="keyword">for</span> i = 1:length(Xn) 
0205         Xname{q + i}  = [sprintf(<span class="string">'Sn(%i) '</span>,s) Xn{i}];
0206     <span class="keyword">end</span>
0207     q     = length(Bname);
0208     <span class="keyword">for</span> i = 1:length(Bn) 
0209         Bname{q + i}  = [sprintf(<span class="string">'Sn(%i) '</span>,s) Bn{i}];
0210     <span class="keyword">end</span>
0211 
0212     <span class="comment">% append into Xx and Xb</span>
0213     <span class="comment">%===============================================================</span>
0214     [x y]   = size(Xx);
0215     [i j]   = size(X);
0216     Xx(([1:i] + x),([1:j] + y)) = spm_detrend(X);
0217     [x y]   = size(Xb);
0218     [i j]   = size(B);
0219     Xb(([1:i] + x),([1:j] + y)) = B;
0220 
0221 <span class="keyword">end</span> <span class="comment">%- for s = 1:nsess</span>
0222 
0223 <span class="comment">% finished</span>
0224 <span class="comment">%-----------------------------------------------------------------------</span>
0225 xX     = struct(    <span class="string">'X'</span>,        [Xx Xb],<span class="keyword">...</span>
0226             <span class="string">'dt'</span>,        dt,<span class="keyword">...</span>
0227             <span class="string">'RT'</span>,        RT,<span class="keyword">...</span>
0228             <span class="string">'iH'</span>,        [],<span class="keyword">...</span>
0229             <span class="string">'iC'</span>,        [1:size(Xx,2)],<span class="keyword">...</span>
0230             <span class="string">'iB'</span>,        [1:size(Xb,2)] + size(Xx,2),<span class="keyword">...</span>
0231             <span class="string">'iG'</span>,        [],<span class="keyword">...</span>
0232             <span class="string">'Xnames'</span>,    {[Xname Bname]});
0233 
0234 
0235 <span class="comment">%-End</span>
0236 <span class="comment">%-----------------------------------------------------------------------</span>
0237 fprintf(<span class="string">'\t%-32s: '</span>,<span class="string">'Saving fMRI design'</span>)                            <span class="comment">%-#</span>
0238 SPM = struct(<span class="string">'SPMid'</span>, SPMid, <span class="keyword">...</span>
0239          <span class="string">'xX'</span>, xX,<span class="keyword">...</span>
0240          <span class="string">'Sess'</span>, {Sess});
0241 fprintf(<span class="string">'%30s\n\n'</span>,<span class="string">'...saved'</span>)                    <span class="comment">%-#</span>
0242 spm_input(<span class="string">'!DeleteInputObj'</span>)
0243 
</pre></div>

<hr><address>Generated on Tue 01-Jun-2021 15:51:18 by <strong><a href="https://www.artefact.tk/software/matlab/m2html/">m2html</a></strong> &copy; 2003-2019</address>
</body>
</html>
